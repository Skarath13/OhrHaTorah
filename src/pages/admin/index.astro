---
// /admin redirects to login (or homepage if already logged in)
let redirectTo = '/admin/login';

const runtime = Astro.locals.runtime;
if (runtime?.env?.DB) {
  try {
    const { validateSession, getSessionFromCookies } = await import('../../lib/auth');
    const cookieHeader = Astro.request.headers.get('cookie');
    const sessionId = getSessionFromCookies(cookieHeader);

    if (sessionId) {
      const user = await validateSession(runtime.env.DB, sessionId);
      if (user) {
        redirectTo = '/';
      }
    }
  } catch (e) {
    // If auth check fails, redirect to login
    console.error('Auth check failed:', e);
  }
}

return Astro.redirect(redirectTo);
---
