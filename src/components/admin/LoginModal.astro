---
// Login Modal Component - Overlay login form triggered from footer
---

<!-- Login Modal -->
<div id="loginModal" class="login-modal">
  <div class="login-modal-backdrop"></div>
  <div class="login-modal-content">
    <button class="login-modal-close" id="loginModalClose" aria-label="Close">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    <div class="login-logo">&#x2721;</div>
    <h2>Admin Login</h2>
    <p class="login-subtitle">Enter your 6-digit PIN</p>

    <form id="loginModalForm">
      <label class="pin-label">Security PIN</label>
      <div class="pin-inputs">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="0" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="1" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="2" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="3" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="4" autocomplete="off">
        <input type="text" inputmode="numeric" pattern="[0-9]*" maxlength="1" class="pin-input" data-index="5" autocomplete="off">
      </div>
      <input type="hidden" name="pin" id="loginPinValue">

      <button type="submit" class="submit-btn" id="loginSubmitBtn" disabled>
        <span class="btn-text">Sign In</span>
        <div class="loading-spinner"></div>
      </button>

      <div class="error-message" id="loginErrorMessage"></div>
    </form>
  </div>
</div>

<style>
  .login-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 10003;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .login-modal.visible {
    display: flex;
  }

  .login-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
  }

  .login-modal-content {
    position: relative;
    background: white;
    border-radius: 20px;
    padding: 40px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    text-align: center;
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(-20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .login-modal-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    cursor: pointer;
    color: #718096;
    padding: 4px;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .login-modal-close:hover {
    background: #f7fafc;
    color: #2d3748;
  }

  .login-logo {
    font-size: 48px;
    margin-bottom: 10px;
    color: #1a365d;
  }

  .login-modal-content h2 {
    color: #1a365d;
    font-size: 24px;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .login-subtitle {
    color: #718096;
    font-size: 14px;
    margin-bottom: 30px;
  }

  .pin-label {
    color: #4a5568;
    font-size: 14px;
    font-weight: 500;
    margin-bottom: 16px;
    display: block;
  }

  .pin-inputs {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 24px;
  }

  .pin-input {
    width: 48px;
    height: 56px;
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    outline: none;
    transition: all 0.2s ease;
    color: #1a365d;
    -moz-appearance: textfield;
  }

  .pin-input::-webkit-outer-spin-button,
  .pin-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .pin-input:focus {
    border-color: #3182ce;
    box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.2);
  }

  .pin-input.filled {
    background: #f7fafc;
    border-color: #3182ce;
  }

  .pin-input.error {
    border-color: #e53e3e;
    animation: shake 0.5s ease-in-out;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
  }

  .submit-btn {
    width: 100%;
    padding: 14px 24px;
    background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .submit-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -5px rgba(49, 130, 206, 0.4);
  }

  .submit-btn:active:not(:disabled) {
    transform: translateY(0);
  }

  .submit-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .error-message {
    color: #e53e3e;
    font-size: 14px;
    margin-top: 16px;
    padding: 12px;
    background: #fff5f5;
    border-radius: 8px;
    display: none;
  }

  .error-message.show {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    display: none;
  }

  .submit-btn.loading .loading-spinner {
    display: block;
  }

  .submit-btn.loading .btn-text {
    display: none;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  @media (max-width: 480px) {
    .login-modal-content {
      padding: 30px 20px;
    }

    .pin-input {
      width: 42px;
      height: 50px;
      font-size: 20px;
    }

    .pin-inputs {
      gap: 8px;
    }
  }
</style>

<script is:inline>
(function() {
  'use strict';

  const modal = document.getElementById('loginModal');
  const backdrop = modal.querySelector('.login-modal-backdrop');
  const closeBtn = document.getElementById('loginModalClose');
  const form = document.getElementById('loginModalForm');
  const inputs = modal.querySelectorAll('.pin-input');
  const submitBtn = document.getElementById('loginSubmitBtn');
  const pinValue = document.getElementById('loginPinValue');
  const errorMessage = document.getElementById('loginErrorMessage');

  // Expose global function to show modal
  window.showLoginModal = function() {
    modal.classList.add('visible');
    document.body.style.overflow = 'hidden';
    resetForm();
    inputs[0].focus();
  };

  window.hideLoginModal = function() {
    modal.classList.remove('visible');
    document.body.style.overflow = '';
    resetForm();
  };

  function resetForm() {
    inputs.forEach(inp => {
      inp.value = '';
      inp.classList.remove('filled', 'error');
    });
    pinValue.value = '';
    submitBtn.disabled = true;
    submitBtn.classList.remove('loading');
    errorMessage.classList.remove('show');
  }

  // Close modal handlers
  closeBtn.addEventListener('click', window.hideLoginModal);
  backdrop.addEventListener('click', window.hideLoginModal);

  // Escape key closes modal
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('visible')) {
      window.hideLoginModal();
    }
  });

  // PIN input handling
  inputs.forEach((input, index) => {
    input.addEventListener('input', (e) => {
      const value = e.target.value;

      // Only allow numbers
      if (!/^\d*$/.test(value)) {
        e.target.value = '';
        return;
      }

      // Move to next input
      if (value && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }

      updateInputStates();
      errorMessage.classList.remove('show');
      inputs.forEach(inp => inp.classList.remove('error'));
    });

    // Handle backspace
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !e.target.value && index > 0) {
        inputs[index - 1].focus();
        inputs[index - 1].value = '';
        updateInputStates();
      }
    });

    // Handle paste
    input.addEventListener('paste', (e) => {
      e.preventDefault();
      const pastedData = e.clipboardData.getData('text').replace(/\D/g, '').slice(0, 6);

      if (pastedData) {
        pastedData.split('').forEach((char, i) => {
          if (inputs[i]) {
            inputs[i].value = char;
          }
        });

        const nextIndex = Math.min(pastedData.length, inputs.length - 1);
        inputs[nextIndex].focus();
        updateInputStates();
      }
    });

    // Handle focus
    input.addEventListener('focus', () => {
      input.select();
    });
  });

  function updateInputStates() {
    let allFilled = true;
    let pin = '';

    inputs.forEach(input => {
      if (input.value) {
        input.classList.add('filled');
        pin += input.value;
      } else {
        input.classList.remove('filled');
        allFilled = false;
      }
    });

    pinValue.value = pin;
    submitBtn.disabled = !allFilled;
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const pin = pinValue.value;
    if (pin.length !== 6) return;

    submitBtn.classList.add('loading');
    submitBtn.disabled = true;

    try {
      const response = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ pin }),
      });

      const data = await response.json();

      if (response.ok && data.success) {
        // Success - close modal and dispatch event
        window.hideLoginModal();

        // Dispatch custom event for InlineEditor to listen to
        window.dispatchEvent(new CustomEvent('adminLoginSuccess', { detail: data.user }));

        // Show the FAB if InlineEditor is present
        const fab = document.getElementById('adminEditFab');
        if (fab) {
          fab.style.display = 'flex';
        }
      } else {
        showError(data.error || 'Invalid PIN');
      }
    } catch (err) {
      showError('Connection error. Please try again.');
    } finally {
      submitBtn.classList.remove('loading');
      updateInputStates();
    }
  });

  function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.add('show');
    inputs.forEach(inp => inp.classList.add('error'));

    // Clear inputs
    inputs.forEach(inp => {
      inp.value = '';
      inp.classList.remove('filled');
    });
    inputs[0].focus();

    // Auto-hide after 5 seconds
    setTimeout(() => {
      errorMessage.classList.remove('show');
      inputs.forEach(inp => inp.classList.remove('error'));
    }, 5000);
  }

  // Setup admin link in footer
  document.addEventListener('DOMContentLoaded', () => {
    const adminLink = document.getElementById('adminLoginLink');
    if (adminLink) {
      adminLink.addEventListener('click', (e) => {
        e.preventDefault();

        // Check if already logged in
        if (document.cookie.includes('oht_logged_in')) {
          // Already logged in - show FAB and maybe enter edit mode
          const fab = document.getElementById('adminEditFab');
          if (fab) {
            fab.style.display = 'flex';
            // Scroll to show FAB
            window.scrollTo({ top: 0, behavior: 'smooth' });
          }
        } else {
          window.showLoginModal();
        }
      });
    }
  });
})();
</script>
